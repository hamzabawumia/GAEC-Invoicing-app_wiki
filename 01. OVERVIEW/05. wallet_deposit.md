# ğŸ“˜ Use Case: Deposit Money Into Patient Wallet

## ğŸ¯ Goal

Allow a patient (or cashier on behalf of a patient) to deposit money into the patientâ€™s wallet, increasing the wallet balance while ensuring:

- Wallet balance is updated authoritatively on the server
- Deposit is auditable and reversible
- No negative or inconsistent wallet states occur

---

## ğŸ”— Entry Point (URL)

Wallet Deposit API (Increase Wallet Balance)
ğŸ¯ Purpose

Allow a cashier to deposit money into a patientâ€™s wallet.

This is NOT a bill payment.

1ï¸âƒ£ Model (You already have this)

You already have:

from client_wallet.models import Wallet_Account


Assumption (based on your usage):

Wallet_Account(
    patient_id=PatientProfile,
    account_balance=Decimal
)


No changes needed here.

2ï¸âƒ£ Serializer (DRF)
# invoicing_app/serializers.py
from rest_framework import serializers
from decimal import Decimal
from client_wallet.models import Wallet_Account
from smcapp1.models import PatientProfile

class WalletDepositSerializer(serializers.Serializer):
    patient_id = serializers.IntegerField()
    amount = serializers.DecimalField(max_digits=10, decimal_places=2)

    def validate_amount(self, value):
        if value <= 0:
            raise serializers.ValidationError("Deposit amount must be greater than zero")
        return value

3ï¸âƒ£ Service Layer (Authoritative Logic)
# invoicing_app/services/wallet_services.py
from django.db import transaction
from django.db.models import F
from client_wallet.models import Wallet_Account
from smcapp1.models import PatientProfile

@transaction.atomic
def deposit_to_wallet(patient_id, amount):
    patient = PatientProfile.objects.get(id=patient_id)

    wallet, created = Wallet_Account.objects.select_for_update().get_or_create(
        patient_id=patient,
        defaults={"account_balance": 0}
    )

    Wallet_Account.objects.filter(
        id=wallet.id
    ).update(account_balance=F('account_balance') + amount)

    return True


Why this is correct:

select_for_update() â†’ race-condition safe

Atomic â†’ no partial state

No billing contamination

4ï¸âƒ£ API View (DRF)
# invoicing_app/views.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .serializers import WalletDepositSerializer
from .services.wallet_services import deposit_to_wallet

class WalletDepositAPIView(APIView):
    def post(self, request):
        serializer = WalletDepositSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        deposit_to_wallet(
            patient_id=serializer.validated_data["patient_id"],
            amount=serializer.validated_data["amount"]
        )

        return Response(
            {"message": "Wallet deposit successful"},
            status=status.HTTP_201_CREATED
        )

5ï¸âƒ£ URL
# invoicing_app/urls.py
path("wallet/deposit/", WalletDepositAPIView.as_view(), name="wallet-deposit"),

âœ… Result

âœ” Wallet balance increases
âœ” Auditable
âœ” No billing side-effects
