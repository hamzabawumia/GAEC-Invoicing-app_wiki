# üìò Use Case: Deposit Money Into Patient Wallet

## üéØ Goal

Allow a patient (or cashier on behalf of a patient) to deposit money into the patient‚Äôs wallet, increasing the wallet balance while ensuring:

- Wallet balance is updated authoritatively on the server
- Deposit is auditable and reversible
- No negative or inconsistent wallet states occur

---

## üîó Entry Point (URL)

‚ö†Ô∏è **Current State of the System**

There is **no explicit API endpoint** in `invoicing_app/urls.py` dedicated to wallet deposits.

This use case is currently expected to be triggered via:
- Django Admin
- Internal service logic
- A future API endpoint (recommended)

--------------------------------------------------
Wallet payment already exists (implicitly)

This is very important:

‚úÖ Wallet payment logic already lives in Deposit_Receiving.clean()

From your model:

if self.payment_method == 'Wallet Account':
    balance = Wallet_Account.objects.get(patient_id__id=self.patient_id)

    if balance.account_balance - self.amount_paid >= 0:
        Wallet_Account.objects.filter(
            patient_id__id=self.patient_id
        ).update(account_balance=F('account_balance')-self.amount_paid)

        self.cash_received = self.amount_paid
        self.change = self.cash_received - self.amount_paid
        self.description = "Paid from client's WALLET"


üìå Meaning
When a Deposit_Receiving record is saved (Admin or API):

Wallet balance is debited

Payment proceeds exactly like cash

All cascading logic in save_model() runs unchanged


--------------------------------------------------

### üîÆ Recommended Future Entry Point


2Ô∏è‚É£ Use Case 1 ‚Äì Wallet Deposit (NEW CODE REQUIRED)
üéØ What this use case is

A wallet deposit is NOT a bill payment.

It must:

Increase wallet balance

Create an auditable record

Not touch invoices or bridges

üî¥ Important

Do NOT use Deposit_Receiving for wallet deposits
That model is explicitly a bill payment model.

‚úÖ Recommended model (if not already present)

If your client_wallet app already has something similar, reuse it.
Otherwise:

# client_wallet/models.py
class WalletDeposit(models.Model):
    patient = models.ForeignKey(PatientProfile, on_delete=models.CASCADE)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    received_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    created = models.DateTimeField(auto_now_add=True)
    description = models.TextField(blank=True)

‚úÖ Service function (core logic)
# client_wallet/services.py
from django.db import transaction
from django.db.models import F

@transaction.atomic
def deposit_to_wallet(patient, amount, user):
    if amount <= 0:
        raise ValueError("Deposit amount must be greater than zero")

    wallet, _ = Wallet_Account.objects.get_or_create(patient_id=patient)

    Wallet_Account.objects.filter(
        id=wallet.id
    ).update(account_balance=F('account_balance') + amount)

    WalletDeposit.objects.create(
        patient=patient,
        amount=amount,
        received_by=user,
        description="Wallet deposit"
    )

‚úÖ DRF API (optional but recommended)
# invoicing_app/views.py
class WalletDepositView(APIView):
    def post(self, request):
        patient_id = request.data['patient_id']
        amount = Decimal(request.data['amount'])

        patient = PatientProfile.objects.get(id=patient_id)

        deposit_to_wallet(
            patient=patient,
            amount=amount,
            user=request.user
        )

        return Response({"status": "wallet funded"})

‚úÖ URL
# invoicing_app/urls.py
path('wallet/deposit/', WalletDepositView.as_view())

