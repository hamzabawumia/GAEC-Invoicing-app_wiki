# üìò Use Case: Pay a Bill Using Wallet Balance

## üéØ Goal

Allow a patient to pay an outstanding bill using funds from their wallet account while guaranteeing:

- Wallet balance is sufficient before payment
- Wallet deduction and bill payment occur atomically
- Billing behavior is identical to other payment methods
- No partial or inconsistent state is possible

---

## üîó Entry Point (URL)

```
POST /invoicing_app/payments/create/
```

> Wallet payments use the same payment creation endpoint as other payment methods.
> The distinguishing factor is `payment_method = "Wallet"`.

**URL configuration:**
- `invoicing_app/urls.py`

```python
url(r'^payments/create/$', create_payment, name='create_payment')
```

---

## üë§ User Actions

1. Cashier selects a consultation / invoice
2. Cashier selects department (or `ALL`)
3. Cashier selects **Wallet** as payment method
4. Cashier submits payment

The cashier expects:
- Wallet balance validation
- Bill to be fully paid
- Wallet balance to decrease accordingly
- Items to be marked as paid

---

## ‚öôÔ∏è System Reaction

### Step 1: Frontend / UI

- Payment form is rendered
- Cashier selects `payment_method = Wallet`
- No cash amount or change is entered

**Not trusted:**
- Wallet balance shown in UI
- Any client-side calculations

**Code location(s):**
- Frontend / Admin UI
- `invoicing_app/urls.py`

---

### Step 2: Transport Layer

- POST request submitted to payment endpoint
- Payload includes:

```json
{
  "invoice_id": <consultation_id>,
  "department": "Laboratory",
  "payment_method": "Wallet"
}
```

**Ignored / overwritten fields:**
- `amount_paid`
- `cash_received`

**Code location(s):**
- `invoicing_app/urls.py`
- `invoicing_app/serializer.py` (`DepositReceivingSerializer`)

---

### Step 3: Backend Logic ‚Äî Validation & Enforcement

#### 3.1 Calculate Bill Total (Authoritative)

- `PaymentCalculationService.calculate_department_amount()` recalculates the bill total server-side

**Code location(s):**
- `invoicing_app/payment_services.py`

---

#### 3.2 Validate Wallet Balance

- System fetches the patient‚Äôs wallet account
- Wallet balance is compared against the bill total

**Enforced rule:**
```
wallet_balance >= bill_total
```

**Failure behavior:**
- If wallet balance is insufficient, payment is rejected

**Code location(s):**
- `client_wallet/models.py` (`Wallet_Account`)
- (Wallet validation logic integrated into payment flow)

---

### Step 4: Atomic Payment Processing

Once wallet balance is validated:

#### 4.1 Deduct Wallet Balance

- Wallet balance is reduced by the bill total
- Wallet balance is never allowed to go below zero

#### 4.2 Create Payment Record

- `Deposit_Receiving` record is created
- `amount_paid` is set to the bill total
- `payment_method` is set to `Wallet`

#### 4.3 Process Payment Normally

- `PaymentProcessingService.process_transaction()` executes:
  - Tracks paid items via M2M relations
  - Marks bridge items as paid
  - Updates receipt numbers
  - Updates stock (Pharmacy)
  - Creates lab result records (Laboratory)

**Important:**
> Wallet only changes the source of funds, not billing behavior.

**Code location(s):**
- `invoicing_app/views.py`
- `invoicing_app/payment_services.py`

---

### Step 5: Persistence

All operations are committed atomically:

- Wallet balance updated
- Payment record saved
- Items marked as paid
- Receipts linked

If any step fails, all changes are rolled back.

**Transaction boundary:**
```python
@transaction.atomic
```

**Code location(s):**
- `invoicing_app/views.py`

---

## üîí Invariants

- Wallet balance can never be negative
- Wallet payment must fully cover the bill
- Wallet deduction and billing updates are atomic
- Client input never controls wallet deduction

---

## ‚ùå What This Use Case Does NOT Do

- Does NOT allow partial wallet payments
- Does NOT mix wallet and cash in one transaction
- Does NOT trust client-reported wallet balances

---

## ‚úÖ Final Outcome

- Bill is fully paid
- Wallet balance is reduced
- Items are marked as paid
- System state remains consistent and audit-safe

