# ğŸ“˜ Use Case: Create and Process a Payment

## ğŸ¯ Goal

Create a payment for outstanding bills while enforcing server-side totals, updating payment status across all related items, and ensuring atomic consistency.

---

## ğŸ”— Entry Point (URL)

```
POST /invoicing_app/payments/create/
```

**URL configuration:**
- `invoicing_app/urls.py`

```python
url(r'^payments/create/$', create_payment, name='create_payment')
```

---

## ğŸ‘¤ User Actions

1. Cashier selects a consultation / invoice
2. Cashier selects department (or `ALL`)
3. Cashier selects payment method (Cash, Transfer, Wallet, etc.)
4. Cashier submits payment

---

## âš™ï¸ System Reaction

### Step 1: Frontend / API Client

- Sends POST request with payment intent
- Client-provided monetary values are treated as untrusted

**Code location(s):**
- Frontend / API client
- `invoicing_app/urls.py`

---

### Step 2: Transport Layer

- Request routed via URL resolver
- Authentication and permissions enforced
- `DepositReceivingSerializer` validates structure and intent

**Code location(s):**
- `invoicing_app/urls.py`
- `invoicing_app/serializer.py`

---

### Step 3: Backend Logic

1. Consultation record is fetched
2. Bill total is recalculated using `PaymentCalculationService`
3. Underpayment is rejected
4. `Deposit_Receiving` record is created
5. `PaymentProcessingService.process_transaction()` executes:
   - Tracks paid items (M2M)
   - Marks bridge items as paid
   - Updates receipt numbers
   - Updates stock (Pharmacy)
   - Creates lab result records (Laboratory)

**Code location(s):**
- `invoicing_app/views.py`
- `invoicing_app/payment_services.py`

---

### Step 4: Persistence

- Payment record saved
- Bridge tables updated
- M2M relationships populated
- Change calculated and stored

**Transaction boundary:**
- `@transaction.atomic`

**Code location(s):**
- `invoicing_app/models.py`

---

## ğŸ”’ Invariants

- All totals are server-calculated
- No partial updates allowed
- Payment status updates are consistent
- Billing logic is payment-method agnostic

---

## âŒ What This Use Case Does NOT Do

- Does NOT trust client-side calculations
- Does NOT allow partial department payments
- Does NOT bypass service-layer enforcement

---

## âœ… Final Outcome

- Payment is completed
- Items are marked as paid
- System state is consistent and audit-safe

