# ğŸ“˜ Use Case: Reverse a Payment

## ğŸ¯ Goal

Safely reverse a previously completed payment while preserving audit integrity and restoring unpaid status to all affected items.

---

## ğŸ”— Entry Point (URL)

```
POST /invoicing_app/payments/<payment_id>/reverse/
```

**URL configuration:**
- `invoicing_app/urls.py`

```python
url(r'^payments/(?P<payment_id>\d+)/reverse/', reverse_payment, name='reverse_payment')
```

---

## ğŸ‘¤ User Actions

1. Cashier or admin selects a payment record
2. User provides a reason for reversal
3. User confirms reversal

---

## âš™ï¸ System Reaction

### Step 1: Frontend / API Client

- Sends POST request with `reason_for_reversal`
- Reversal intent is explicit

**Code location(s):**
- Frontend / API client
- `invoicing_app/urls.py`

---

### Step 2: Transport Layer

- Request routed via URL resolver
- Authentication enforced
- `RefundReversalSerializer` validates:
  - Reversal flag
  - Reason requirement

**Code location(s):**
- `invoicing_app/urls.py`
- `invoicing_app/serializer.py`

---

### Step 3: Backend Logic

1. Payment record is fetched
2. Reversal metadata is persisted on the payment
3. `PaymentReversalService.reverse_payment()` executes:
   - Iterates through M2M paid items
   - Resets `paid` and `nhis_co_payment_paid`
   - Clears M2M relationships
   - Restores consultation payment status

**Code location(s):**
- `invoicing_app/views.py`
- `invoicing_app/refund_reversal_services.py`

---

### Step 4: Persistence

- Payment marked as reversed
- Items returned to unpaid state
- No records are deleted

**Transaction boundary:**
- `@transaction.atomic`

**Code location(s):**
- `invoicing_app/models.py`

---

## ğŸ”’ Invariants

- Reversal requires an explicit reason
- Reversal can occur only once
- Audit fields are preserved
- System state is restored consistently

---

## âŒ What This Use Case Does NOT Do

- Does NOT delete payment records
- Does NOT automatically restore stock
- Does NOT allow silent reversals

---

## âœ… Final Outcome

- Payment is safely reversed
- Items are unpaid
- Audit trail remains intact

