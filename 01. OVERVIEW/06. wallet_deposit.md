# ğŸ“˜ Use Case: Deposit Money Into Patient Wallet

## ğŸ¯ Goal

Allow a patient (or cashier on behalf of a patient) to deposit money into the patientâ€™s wallet, increasing the wallet balance while ensuring:

- Wallet balance is updated authoritatively on the server
- Deposit is auditable and reversible
- No negative or inconsistent wallet states occur

---

## ğŸ”— Entry Point (URL)

âš ï¸ **Current State of the System**

There is **no explicit API endpoint** in `invoicing_app/urls.py` dedicated to wallet deposits.

This use case is currently expected to be triggered via:
- Django Admin
- Internal service logic
- A future API endpoint (recommended)

### ğŸ”® Recommended Future Entry Point

```
POST /invoicing_app/wallet/deposit/
```

---

## ğŸ‘¤ User Actions

1. Cashier selects a patient
2. Cashier enters a deposit amount
3. Cashier confirms wallet deposit

The user expects:
- Wallet balance to increase
- Deposit to be recorded
- Deposit to be reversible if needed

---

## âš™ï¸ System Reaction

### Step 1: Frontend / Admin UI

- Wallet deposit form is rendered
- Cashier enters deposit amount

**Not trusted:**
- Client-side wallet balance
- Any calculated totals

**Code location(s):**
- Django Admin / UI layer

---

### Step 2: Transport Layer

- Deposit request is submitted
- Deposit amount and patient identity are transmitted

**Code location(s):**
- (Admin or future API endpoint)

---

### Step 3: Backend Logic

1. System validates deposit intent
2. Wallet account is fetched using patient identifier
3. Deposit amount is validated to be positive
4. Wallet balance is increased by deposit amount
5. Wallet deposit transaction record is created

**Enforced rules:**
- Deposit amount must be greater than zero
- Wallet balance is authoritative server-side

**Code location(s):**
- `client_wallet/models.py` (`Wallet_Account`)
- Wallet deposit model (external app)

---

### Step 4: Persistence

- Wallet balance is updated
- Wallet deposit record is saved
- Audit fields are populated

**Transaction boundary:**
- `@transaction.atomic`

**Code location(s):**
- Wallet deposit model
- `client_wallet/models.py`

---

## ğŸ”’ Invariants

- Wallet balance can never be negative
- Deposits must always increase wallet balance
- Deposit records are never deleted
- Each deposit is independently auditable

---

## âŒ What This Use Case Does NOT Do

- Does NOT pay bills
- Does NOT mark any billing items as paid
- Does NOT bypass audit logging

---

## âœ… Final Outcome

- Wallet balance is increased
- Deposit transaction is recorded
- System state remains consistent and auditable

---

## ğŸ§  Notes for the Team

- This use case pairs directly with:
  - `wallet-payment.md`
  - wallet reversal logic in `refund_reversal_services.py`
- A dedicated API endpoint is recommended for parity with other payment flows

